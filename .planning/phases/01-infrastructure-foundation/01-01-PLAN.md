---
phase: 01-infrastructure-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - .env.example
  - .env
  - .gitignore
autonomous: false

must_haves:
  truths:
    - "Ghost admin accessible at localhost:2368/ghost"
    - "User can create admin account via setup wizard"
    - "Test article persists after container recreation"
    - "mysqldump exports database successfully"
    - "Stack can be destroyed and recreated without data loss"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Ghost + MySQL stack definition"
      contains: "ghost:6-alpine"
    - path: ".env.example"
      provides: "Environment variable template"
      contains: "MYSQL_ROOT_PASSWORD"
    - path: ".env"
      provides: "Actual secrets for local testing"
      contains: "GHOST_DB_PASSWORD"
    - path: ".gitignore"
      provides: "Excludes secrets from git"
      contains: ".env"
  key_links:
    - from: "docker-compose.yml"
      to: ".env"
      via: "${VARIABLE} interpolation"
      pattern: "\\$\\{GHOST_DB_PASSWORD\\}"
    - from: "ghost service"
      to: "mysql service"
      via: "depends_on with service_healthy"
      pattern: "condition: service_healthy"
    - from: "ghost_content volume"
      to: "/var/lib/ghost/content"
      via: "volume mount"
      pattern: "ghost_content:/var/lib/ghost/content"
---

<objective>
Create and validate a working Ghost 6.x + MySQL 8 Docker Compose stack for local development.

Purpose: Establish the infrastructure foundation that all subsequent phases depend on. Ghost must be running, accessible, and persistent before theming or content migration.

Output: Working docker-compose.yml stack with named volumes, proper healthchecks, and validated data persistence.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-infrastructure-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Docker Compose stack files</name>
  <files>
    docker-compose.yml
    .env.example
    .env
    .gitignore
  </files>
  <action>
Create the following files at project root:

**docker-compose.yml** - Use the exact pattern from 01-RESEARCH.md:
- Ghost service: `ghost:6-alpine` image, depends on mysql with `condition: service_healthy`
- MySQL service: `mysql:8.0` image with proper healthcheck using actual SQL query (NOT mysqladmin ping)
- Named volumes: `ghost_content` mounted to `/var/lib/ghost/content`, `mysql_data` mounted to `/var/lib/mysql`
- Environment variables via `${VARIABLE}` syntax for secrets
- Set `NODE_ENV: production` explicitly (critical - Ghost defaults to dev mode)
- Network: bridge network for service communication

**Healthcheck must use actual SQL query:**
```yaml
healthcheck:
  test: ["CMD", "mysql", "-ughost", "-p${GHOST_DB_PASSWORD}", "-e", "SELECT 1"]
  interval: 10s
  timeout: 5s
  retries: 10
  start_period: 30s
```

**.env.example** - Template showing required variables:
```
# Generate with: openssl rand -hex 32
MYSQL_ROOT_PASSWORD=
GHOST_DB_PASSWORD=
```

**.env** - Generate actual credentials:
- Run `openssl rand -hex 32` twice to generate MYSQL_ROOT_PASSWORD and GHOST_DB_PASSWORD
- Populate .env with generated values

**.gitignore** - Ensure .env is excluded:
- Add `.env` if not already present
- Keep `.env.example` tracked
  </action>
  <verify>
- `cat docker-compose.yml` shows Ghost 6 + MySQL 8 configuration
- `cat .env.example` shows template with empty values
- `cat .env` shows populated secrets (different from example)
- `grep ".env" .gitignore` returns match
- `docker compose config` validates compose file syntax (uses .env values)
  </verify>
  <done>
docker-compose.yml, .env.example, .env, and .gitignore exist with correct content. Compose file validates without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Start stack and verify Ghost boots</name>
  <files>None (runtime verification)</files>
  <action>
Start the Docker Compose stack and verify Ghost initializes:

1. Run `docker compose up -d` to start in detached mode
2. Wait for MySQL healthcheck to pass (up to 60 seconds)
3. Wait for Ghost to boot (check logs for "Ghost booted")
4. Verify Ghost responds at localhost:2368

**Commands:**
```bash
docker compose up -d
docker compose logs -f mysql 2>&1 | head -50  # Check MySQL startup
docker compose ps  # Verify both services healthy
curl -s -o /dev/null -w "%{http_code}" http://localhost:2368  # Should return 200 or 302
```

**Troubleshooting if Ghost fails:**
- Check `docker compose logs ghost` for errors
- Verify MySQL shows "healthy" in `docker compose ps`
- Common issue: Ghost starts before MySQL ready (healthcheck should prevent this)
  </action>
  <verify>
- `docker compose ps` shows both ghost and mysql running with healthy status
- `curl -I http://localhost:2368` returns HTTP 200 or 302 (redirect to setup)
- `docker compose logs ghost | grep -i "booted"` shows Ghost started successfully
  </verify>
  <done>
Ghost container running and responding at localhost:2368. MySQL healthy. No crash loops in logs.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Ghost 6.x + MySQL 8 Docker stack with persistence volumes and proper healthchecks. Ghost should be accessible for initial setup.
  </what-built>
  <how-to-verify>
**Part 1: Admin Setup**
1. Open http://localhost:2368/ghost in browser
2. Complete Ghost setup wizard (create admin account)
3. Create a test post titled "Persistence Test" with some content
4. Publish the post

**Part 2: Persistence Validation**
5. Run these commands to recreate Ghost container (Claude will provide):
   ```bash
   docker compose down
   docker compose up -d
   ```
6. Wait 30 seconds for services to restart
7. Open http://localhost:2368/ghost and log in
8. Verify "Persistence Test" post still exists

**Part 3: Backup Verification**
9. Claude will run mysqldump and report success/failure

**Expected Results:**
- Ghost setup wizard works
- Admin account created
- Test post persists after container recreation
- mysqldump succeeds
  </how-to-verify>
  <resume-signal>Type "verified" if all tests pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
**Phase 1 Success Criteria Validation:**

1. Ghost admin accessible at localhost:2368/ghost with account created
   - Test: Browser access + login works

2. Test article persists after container recreation
   - Test: Post exists after `docker compose down && docker compose up -d`

3. MySQL backup works (mysqldump succeeds)
   - Test: `docker exec ghost-mysql mysqldump -u ghost -p"$GHOST_DB_PASSWORD" ghost > backup.sql` exits 0

4. Stack is reproducible
   - Test: Can destroy everything (`docker compose down -v`) and recreate from files
</verification>

<success_criteria>
- [ ] docker-compose.yml creates working Ghost + MySQL stack
- [ ] Ghost accessible at localhost:2368
- [ ] Admin account can be created
- [ ] Content persists across container restarts
- [ ] mysqldump successfully exports database
- [ ] Stack can be destroyed and recreated
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-foundation/01-01-SUMMARY.md`
</output>
