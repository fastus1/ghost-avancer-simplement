---
phase: 02-theme-branding
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - content/themes/avancer-simplement/default.hbs
  - content/themes/avancer-simplement/partials/theme-toggle.hbs
  - content/themes/avancer-simplement/assets/js/theme-toggle.js
  - content/themes/avancer-simplement/assets/css/screen.css
autonomous: true

must_haves:
  truths:
    - "Toggle button visible in header"
    - "Clicking toggle switches between light and dark mode"
    - "Theme preference persists in localStorage"
    - "No flash of wrong theme on page load"
  artifacts:
    - path: "content/themes/avancer-simplement/partials/theme-toggle.hbs"
      provides: "Toggle button HTML partial"
      contains: "theme-toggle"
    - path: "content/themes/avancer-simplement/assets/js/theme-toggle.js"
      provides: "Toggle logic with localStorage"
      contains: "localStorage"
    - path: "content/themes/avancer-simplement/default.hbs"
      provides: "Base layout with toggle integration"
      contains: "theme-toggle"
  key_links:
    - from: "default.hbs"
      to: "theme-toggle.hbs"
      via: "Handlebars partial include"
      pattern: '{{>.*theme-toggle'
    - from: "theme-toggle.js"
      to: "html.dark-mode"
      via: "classList.toggle"
      pattern: "classList\\.toggle.*dark-mode|classList\\.add.*dark-mode"
    - from: "default.hbs head"
      to: "localStorage"
      via: "inline script for FOWT prevention"
      pattern: "localStorage.*theme|theme.*localStorage"
---

<objective>
Implement manual dark/light mode toggle with localStorage persistence and FOWT prevention.

Purpose: Give users control over theme appearance (matching Circle.so behavior) with their preference remembered.
Output: Working toggle button in header that switches modes without page flash.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-theme-branding/02-RESEARCH.md
@.planning/phases/02-theme-branding/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create toggle button partial and JavaScript</name>
  <files>
    content/themes/avancer-simplement/partials/theme-toggle.hbs
    content/themes/avancer-simplement/assets/js/theme-toggle.js
  </files>
  <action>
1. Create partials/theme-toggle.hbs:
```handlebars
{{!-- Dark/Light mode toggle button --}}
<button class="theme-toggle" aria-label="Toggle dark mode" aria-pressed="false" type="button">
    <span class="toggle-icon toggle-icon--light" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M12 3a1 1 0 011 1v1a1 1 0 11-2 0V4a1 1 0 011-1zm0 15a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm9-9a1 1 0 110 2h-1a1 1 0 110-2h1zM5 11a1 1 0 110 2H4a1 1 0 110-2h1zm14.07-6.07a1 1 0 010 1.41l-.7.7a1 1 0 11-1.41-1.41l.7-.7a1 1 0 011.41 0zM7.05 16.95a1 1 0 010 1.41l-.7.7a1 1 0 01-1.41-1.41l.7-.7a1 1 0 011.41 0zm11.9 0a1 1 0 011.41 0l.7.7a1 1 0 01-1.41 1.41l-.7-.7a1 1 0 010-1.41zM7.05 7.05a1 1 0 01-1.41 0l-.7-.7a1 1 0 011.41-1.41l.7.7a1 1 0 010 1.41zM12 8a4 4 0 100 8 4 4 0 000-8z"/>
        </svg>
    </span>
    <span class="toggle-icon toggle-icon--dark" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
            <path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
        </svg>
    </span>
</button>
```

2. Create assets/js/theme-toggle.js:
```javascript
/**
 * Theme Toggle - Dark/Light mode with localStorage persistence
 * Preference cascade: localStorage > system preference > light
 */
(function() {
    'use strict';

    const STORAGE_KEY = 'theme-preference';

    function getThemePreference() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            return stored;
        }
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function setTheme(theme) {
        const html = document.documentElement;
        html.classList.toggle('dark-mode', theme === 'dark');
        localStorage.setItem(STORAGE_KEY, theme);
        updateToggleButton(theme);
    }

    function updateToggleButton(theme) {
        const btn = document.querySelector('.theme-toggle');
        if (btn) {
            btn.setAttribute('aria-pressed', theme === 'dark');
            // Show sun icon in dark mode (to switch to light), moon in light mode
            const lightIcon = btn.querySelector('.toggle-icon--light');
            const darkIcon = btn.querySelector('.toggle-icon--dark');
            if (lightIcon && darkIcon) {
                lightIcon.style.display = theme === 'dark' ? 'block' : 'none';
                darkIcon.style.display = theme === 'dark' ? 'none' : 'block';
            }
        }
    }

    function toggleTheme() {
        const html = document.documentElement;
        const current = html.classList.contains('dark-mode') ? 'dark' : 'light';
        setTheme(current === 'dark' ? 'light' : 'dark');
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        // Update button state (theme already applied by inline script)
        updateToggleButton(getThemePreference());

        // Attach click handler
        const toggle = document.querySelector('.theme-toggle');
        if (toggle) {
            toggle.addEventListener('click', toggleTheme);
        }

        // Listen for system preference changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
            // Only update if user hasn't set a preference
            if (!localStorage.getItem(STORAGE_KEY)) {
                setTheme(e.matches ? 'dark' : 'light');
            }
        });
    });
})();
```

3. Add toggle button CSS to screen.css (append to end of file):
```css
/* ============================================
   Theme Toggle Button
   ============================================ */
.theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    padding: 8px;
    cursor: pointer;
    border-radius: 4px;
    color: var(--color-text);
    transition: background-color 0.2s ease;
}

.theme-toggle:hover {
    background-color: var(--color-header-active-bg);
}

.theme-toggle:focus-visible {
    outline: 2px solid var(--color-brand);
    outline-offset: 2px;
}

.toggle-icon {
    display: none;
    line-height: 1;
}

/* Default: show moon (we're in light mode) */
.toggle-icon--dark {
    display: block;
}

/* In dark mode: show sun */
html.dark-mode .toggle-icon--light {
    display: block;
}

html.dark-mode .toggle-icon--dark {
    display: none;
}
```

AVOID: Using emoji icons (they render differently across systems).
WHY: SVG icons ensure consistent appearance everywhere.
  </action>
  <verify>
    - `cat content/themes/avancer-simplement/partials/theme-toggle.hbs | grep "theme-toggle"` returns match
    - `cat content/themes/avancer-simplement/assets/js/theme-toggle.js | grep "localStorage"` returns match
    - `grep "theme-toggle" content/themes/avancer-simplement/assets/css/screen.css` returns match
  </verify>
  <done>
    Toggle button partial, JavaScript logic, and CSS styles are created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate toggle into default.hbs with FOWT prevention</name>
  <files>
    content/themes/avancer-simplement/default.hbs
  </files>
  <action>
Edit default.hbs to:

1. Add FOWT prevention inline script in &lt;head&gt; BEFORE any stylesheets:
Find the &lt;head&gt; section and add this right after &lt;head&gt;:
```html
<script>
    (function() {
        var theme = localStorage.getItem('theme-preference');
        if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark-mode');
        }
    })();
</script>
```

2. Add theme-toggle.js script before &lt;/body&gt; (after other scripts but before {{ghost_foot}}):
```handlebars
<script src="{{asset "js/theme-toggle.js"}}"></script>
```

3. Find the header section (usually .gh-head or similar) and add the toggle partial.
   Look for the header actions area (often .gh-head-actions) and add:
```handlebars
{{> "theme-toggle"}}
```

   In Casper, the header structure is typically in default.hbs. Find:
   - .gh-head-menu (navigation)
   - .gh-head-actions (search, buttons)

   Add the toggle in .gh-head-actions alongside other action buttons.

4. If there's no .gh-head-actions, create it:
```handlebars
<div class="gh-head-actions">
    {{> "theme-toggle"}}
</div>
```

AVOID: Placing inline script AFTER stylesheets.
WHY: Must run before CSS applies to prevent FOWT (Flash of Wrong Theme).
  </action>
  <verify>
    - `grep "theme-preference" content/themes/avancer-simplement/default.hbs` returns match (FOWT script)
    - `grep "theme-toggle" content/themes/avancer-simplement/default.hbs` returns matches (partial + script)
    - `grep "dark-mode" content/themes/avancer-simplement/default.hbs` returns match (in inline script)
  </verify>
  <done>
    default.hbs includes FOWT prevention script in head, toggle button in header, and theme-toggle.js before body close.
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
1. Toggle button renders in header
2. Clicking toggle changes html class between default and dark-mode
3. localStorage stores preference as 'theme-preference'
4. Page load applies stored preference without flash
5. Theme builds successfully with new assets
</verification>

<success_criteria>
- partials/theme-toggle.hbs exists with button markup
- assets/js/theme-toggle.js exists with localStorage logic
- default.hbs has inline FOWT prevention script in head
- default.hbs includes theme-toggle partial
- default.hbs includes theme-toggle.js script
- screen.css includes toggle button styles
- npm run zip succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-theme-branding/02-03-SUMMARY.md`
</output>
